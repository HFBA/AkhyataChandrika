# Multiple Dhatu IDs Workflow

## Overview

According to the project requirements (AI_Doc.md):
- Any Verb with or without gati cannot have more than one dhatu_id
- We need to collect all such cases and create a YAML file for manual correction
- We need infrastructure to backport manual changes back to the original YAML files

This workflow provides two scripts to handle this requirement:

## Scripts

### 1. collectMultipleDhatuIds.py

**Purpose**: Scans the generated JSON file and collects all verbs with multiple dhatu_ids into TWO separate YAML files - one for verbs without gati, and one for verbs with gati.

**Usage**:
```bash
python3 Scripts/collectMultipleDhatuIds.py Scripts/output/AkhyataChandrika_Autogenerated.json Scripts/output
```

**What it does**:
- Reads the auto-generated JSON file
- Finds all verb entries where `dhatu_id` contains "(More than one)"
- Separates them into two categories based on presence of gati
- Creates TWO YAML files with all such cases
- Each entry includes:
  - `form`: The verb form
  - `dhatu_ids`: Comma-separated dhatu IDs (cleaned, without "(More than one)" suffix)
  - `gati`: The upasarga/gati (empty string for verbs without gati)
  - `kanda`: Kanda name
  - `varga`: Varga name
  - `adhikaar`: Adhikaar (if applicable)
  - `artha`: The meaning/artha
  - `shloka_num`: Shloka number
  - `shloka_text`: Full shloka text

**Note**: This script automatically skips the नानार्थवर्गः folder as per user requirements.

**Outputs**:
- `Scripts/output/multiple_dhatu_ids_without_gati.yaml` - Verbs WITHOUT gati (159 cases)
- `Scripts/output/multiple_dhatu_ids_with_gati.yaml` - Verbs WITH gati (126 cases)

### 2. backportMultipleDhatuIds.py

**Purpose**: Syncs manually edited changes from the multiple dhatu IDs YAML files back to the original YAML files.

**Usage**:

Option 1 - Process a single file:
```bash
python3 Scripts/backportMultipleDhatuIds.py Scripts/output/multiple_dhatu_ids_without_gati.yaml Data
```

Option 2 - Process all files in a directory (recommended):
```bash
python3 Scripts/backportMultipleDhatuIds.py Scripts/output Data
```
This will automatically process both `*_without_gati.yaml` and `*_with_gati.yaml` files.

**What it does**:
- Reads the manually edited YAML file(s)
- For each entry:
  - Locates the corresponding original YAML file in the Data folder
  - Finds the specific verb within the shloka and artha
  - Updates the dhatu_id field with the corrected value
  - Preserves the gati field if present
- Writes the updated YAML files back
- Reports which files were modified

**Note**: This script also automatically skips the नानार्थवर्गः folder.

## Workflow

### Step 1: Generate the JSON (if not already done)
```bash
# Use existing scripts to generate JSON from YAML files
```

### Step 2: Collect Multiple Dhatu ID Cases
```bash
python3 Scripts/collectMultipleDhatuIds.py \
    Scripts/output/AkhyataChandrika_Autogenerated.json \
    Scripts/output
```

This will create TWO files:
- `Scripts/output/multiple_dhatu_ids_without_gati.yaml` (159 verbs without gati)
- `Scripts/output/multiple_dhatu_ids_with_gati.yaml` (126 verbs with gati)

### Step 3: Manually Edit the YAML Files

Open both YAML files and edit the `dhatu_ids` field for each entry.

**Recommended approach**: Edit the smaller file first (verbs with gati) as it's easier to review.

**Before** (automatically generated):
```yaml
"फलति":
  "form": "फलति"
  "dhatu_ids": "01.0594, 01.0608"
  "gati": ""
  ...
```

**After** (manually corrected - choose the correct dhatu_id):
```yaml
"फलति":
  "form": "फलति"
  "dhatu_ids": "01.0594"
  "gati": ""
  ...
```

### Step 4: Backport Changes to Original YAML Files

**Recommended**: Process all files at once:
```bash
python3 Scripts/backportMultipleDhatuIds.py Scripts/output Data
```

**Alternative**: Process files individually:
```bash
# Process verbs without gati first
python3 Scripts/backportMultipleDhatuIds.py \
    Scripts/output/multiple_dhatu_ids_without_gati.yaml \
    Data

# Then process verbs with gati
python3 Scripts/backportMultipleDhatuIds.py \
    Scripts/output/multiple_dhatu_ids_with_gati.yaml \
    Data
```

This will update all the original YAML files with your corrections.

### Step 5: Regenerate the JSON
```bash
# Use existing scripts to regenerate JSON from the updated YAML files
```

## Example

### Initial State
The verb "फलति" has two dhatu_ids: `01.0594, 01.0608 (More than one)`

### After Collection
`multiple_dhatu_ids.yaml` contains:
```yaml
"फलति":
  "form": "फलति"
  "dhatu_ids": "01.0594, 01.0608"
  "gati": ""
  "kanda": "प्रथमकाण्डः"
  "varga": "भावविकारवर्गः"
  "artha": "विशरणे"
  "shloka_num": "13"
  "shloka_text": "जूर्यते जारयति च जिनाति च जृणाति च । दलति स्फोटति विशीर्यते फलति शीयते ॥"
```

### Manual Correction
You determine that the correct dhatu_id is `01.0594`, so you edit:
```yaml
"फलति":
  "form": "फलति"
  "dhatu_ids": "01.0594"  # ← Changed from "01.0594, 01.0608"
  ...
```

### After Backport
The original YAML file `Data/1_प्रथमकाण्डः/1_भावविकारवर्गः.yaml` is updated:
```yaml
"जूर्यते जारयति च जिनाति च जृणाति च । दलति स्फोटति विशीर्यते फलति शीयते ॥":
  "विशरणे":
    "फलति":
    - "01.0594"  # ← Updated from ["01.0594, 01.0608"]
```

## Statistics

Current status (as of latest run):
- **Total cases found**: 330 verbs with multiple dhatu_ids
  - **Without gati**: 159 cases → `multiple_dhatu_ids_without_gati.yaml`
  - **With gati**: 126 cases → `multiple_dhatu_ids_with_gati.yaml`
  - Note: Some verbs appear in both categories or with duplicate dhatu_ids, so the unique count is 285 (159 + 126)
- **Files affected**: Multiple YAML files across all kandas and vargas
- **Excluded**: नानार्थवर्गः folder (automatically skipped)

## Notes

- The scripts preserve the YAML structure and formatting
- The नानार्थवर्गः folder is automatically excluded from all operations
- The backport script creates a detailed report of all changes made
- You can run the collection script multiple times to regenerate the `multiple_dhatu_ids.yaml` file
- The backport script will only update entries that are found in the original YAML files
